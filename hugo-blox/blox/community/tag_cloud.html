{{/* Hugo Blox: Tag Cloud - Tailwind Version */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $taxonomy := $block.content.taxonomy | default "tags" }}
{{ $fontSmall := $block.design.font_size_min | default 0.8 }}
{{ $fontBig := $block.design.font_size_max | default 2.5 }}

{{ $items_count := $block.content.count }}
{{ if eq $items_count 0 }}
  {{ $items_count = 65535 }}
{{ else }}
  {{ $items_count = $items_count | default 20 }}
{{ end }}

{{/* Query */}}
{{ $tags := first $items_count (index site.Taxonomies $taxonomy).ByCount }}
{{ $count := len $tags }}

{{ $columns := $block.design.columns | default "1" }}

<div class="w-full {{ if eq $columns "2" }}lg:w-2/3{{ else }}text-center{{ end }}">
  {{ with $block.content.text }}
    <div class="mb-6">{{ . | $page.RenderString | emojify }}</div>
  {{ end }}

  {{ if ne $count 0 }}

    {{ $fontDelta := sub $fontBig $fontSmall }}
    {{/* Warning: Hugo's `Reverse` function appears to operate in-place, hence the order of performing $max/$min matters. */}}
    {{ $max := add (len (index $tags 0).Pages) 1 }}
    {{ $min := len (index ($tags).Reverse 0).Pages }}
    {{ $delta := sub $max $min }}
    {{ $fontStep := div $fontDelta $delta }}

    <div class="flex flex-wrap gap-2 justify-center items-center leading-relaxed">
      {{ range $name, $term := (sort $tags ".Page.Title" "asc") }}
        {{ $tagCount := len $term.Pages }}
        {{ $weight := div (sub (math.Log $tagCount) (math.Log $min)) (sub (math.Log $max) (math.Log $min)) }}
        {{ $fontSize := add $fontSmall (mul (sub $fontBig $fontSmall) $weight) }}

        {{/* Convert rem size to Tailwind classes */}}
        {{ $sizeClass := "text-base" }}
        {{ if lt $fontSize 1.0 }}
          {{ $sizeClass = "text-sm" }}
        {{ else if lt $fontSize 1.25 }}
          {{ $sizeClass = "text-base" }}
        {{ else if lt $fontSize 1.5 }}
          {{ $sizeClass = "text-lg" }}
        {{ else if lt $fontSize 1.875 }}
          {{ $sizeClass = "text-xl" }}
        {{ else if lt $fontSize 2.25 }}
          {{ $sizeClass = "text-2xl" }}
        {{ else }}
          {{ $sizeClass = "text-3xl" }}
        {{ end }}

        <a href="{{ .Page.RelPermalink }}"
           class="{{ $sizeClass }} text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-200 hover:underline">
          {{ .Page.Title }}
        </a>
      {{ end }}
    </div>
  {{ end }}

</div>
