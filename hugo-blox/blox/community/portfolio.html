{{/* ─────────────────────────────────────────────
   Hugo Blox · Portfolio (Academic CV / Tailwind)
   ───────────────────────────────────────────── */}}

{{ $b      := .wcBlock }}
{{ $cols   := cond (in (slice "1" "2" "3") $b.design.columns) $b.design.columns "1" }}
{{ $view   := $b.design.view | default "article-grid" }}

<section id="{{ $b.id | default "portfolio" }}" class="mb-16">

  {{ with $b.content.text }}
  <div class="prose max-w-none mx-auto mb-6 px-4 sm:px-6 lg:px-8 dark:prose-invert">
    {{ . | emojify | $.wcPage.RenderString }}
  </div>
  {{ end }}

  {{/* --------------- filter buttons --------------- */}}
  {{ if gt (len $b.content.buttons) 1 }}
    {{ $def := int ($b.content.default_button_index | default 0) }}
    {{ $defTag := (index $b.content.buttons $def).tag }}
    {{ $defClass := cond (or (hasPrefix $defTag "*") (hasPrefix $defTag ".")) $defTag
                         (printf ".js-id-%s" (replace (lower $defTag) " " "-")) }}
    <span class="hidden default-project-filter">{{ $defClass }}</span>

    <div class="flex flex-wrap justify-center gap-4 mb-8">
      {{ range $i, $btn := $b.content.buttons }}
        {{ $flt := cond (or (hasPrefix $btn.tag "*") (hasPrefix $btn.tag ".")) $btn.tag
                       (printf ".js-id-%s" (replace (lower $btn.tag) " " "-")) }}
        <button data-filter="{{ $flt }}"
                class="rounded px-4 py-2 text-sm font-semibold focus:outline-none focus:ring-2
                       {{ if eq $i $def }}bg-primary-600 text-white
                       {{ else }}bg-primary-100 text-primary-800 hover:bg-primary-200{{ end }}">
          {{ $btn.name }}
        </button>
      {{ end }}
    </div>
  {{ end }}

  {{/* --------------- Hugo query --------------- */}}
  {{ $pages := site.RegularPages }}
  {{ with $b.content.filters.folders      }}{{ $pages = where $pages "Section" "in" . }}{{ end }}
  {{ with $b.content.filters.tags         }}{{ $pages = where $pages "Params.tags" "intersect" . }}{{ end }}
  {{ with $b.content.filters.exclude_tags }}{{ $pages = $pages | symdiff (where site.RegularPages "Params.tags" "intersect" .) }}{{ end }}
  {{ with ($b.content.filters.kinds | default (slice "page")) }}
    {{ $pages = where $pages "Kind" "in" . }}
  {{ end }}

  {{ $sortKey := partial "blox-core/functions/get_sort_by_parameter" ($b.content.sort_by | default "Date") }}
  {{ $pages   = sort $pages $sortKey (cond $b.content.sort_ascending "asc" "desc") }}

  {{/* --------------- responsive grid --------------- */}}
  <div class="grid gap-6 px-4 sm:px-6 lg:px-8
              {{ if eq $cols "1" }}grid-cols-1
              {{ else if eq $cols "2" }}grid-cols-1 md:grid-cols-2
              {{ else }}grid-cols-1 md:grid-cols-2 lg:grid-cols-3{{ end }}">

    {{ range $i, $p := $pages }}
      {{ $tagClasses := delimit (apply (apply (apply $p.Params.tags "replace" "." "-") "printf" "js-id-%s" ".") "lower" ".") " " }}
      <div class="project-card rounded bg-white shadow p-4 {{ $tagClasses }}">
        {{ partial "functions/render_view" (dict "page" $b "item" $p "view" $view "index" $i) }}
      </div>
    {{ end }}

  </div>
</section>
