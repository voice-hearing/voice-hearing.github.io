!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("immutable"),require("uuid")):"function"==typeof define&&define.amd?define("DecapCmsLibAuth",["immutable","uuid"],e):"object"==typeof exports?exports.DecapCmsLibAuth=e(require("immutable"),require("uuid")):t.DecapCmsLibAuth=e(t.DecapCmsDefaultExports.Immutable,t.DecapCmsDefaultExports.UUId)}(window,(t,e)=>(()=>{var r={5:t=>{var e=Object.prototype.toString;t.exports=function(t){return e.call(t)}},13:t=>{var e="\\ud800-\\udfff",r="["+e+"]",n="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",o="\\ud83c[\\udffb-\\udfff]",i="[^"+e+"]",a="(?:\\ud83c[\\udde6-\\uddff]){2}",s="[\\ud800-\\udbff][\\udc00-\\udfff]",c="(?:"+n+"|"+o+")?",u="[\\ufe0e\\ufe0f]?",h=u+c+"(?:\\u200d(?:"+[i,a,s].join("|")+")"+u+c+")*",f="(?:"+[i+n+"?",n,a,s,r].join("|")+")",p=RegExp(o+"(?="+o+")|"+f+h,"g");t.exports=function(t){return t.match(p)||[]}},97:t=>{"use strict";t.exports=e},107:(t,e,r)=>{var n=r(291),o=r(403),i=r(931),a=r(774),s=r(905),c=r(237),u=r(243);t.exports=function(t,e,r){if((t=u(t))&&(r||void 0===e))return o(t);if(!t||!(e=n(e)))return t;var h=c(t),f=c(e),p=s(h,f),l=a(h,f)+1;return i(h,p,l).join("")}},111:t=>{t.exports=function(t,e){for(var r=-1,n=null==t?0:t.length,o=Array(n);++r<n;)o[r]=e(t[r],r,t);return o}},142:t=>{var e=Array.isArray;t.exports=e},187:(t,e,r)=>{var n=r(379),o=r(547);t.exports=function(t){return"symbol"==typeof t||o(t)&&"[object Symbol]"==n(t)}},237:(t,e,r)=>{var n=r(837),o=r(417),i=r(13);t.exports=function(t){return o(t)?i(t):n(t)}},243:(t,e,r)=>{var n=r(291);t.exports=function(t){return null==t?"":n(t)}},250:t=>{t.exports=function(t,e,r,n){for(var o=t.length,i=r+(n?1:-1);n?i--:++i<o;)if(e(t[i],i,t))return i;return-1}},291:(t,e,r)=>{var n=r(650),o=r(111),i=r(142),a=r(187),s=n?n.prototype:void 0,c=s?s.toString:void 0;t.exports=function t(e){if("string"==typeof e)return e;if(i(e))return o(e,t)+"";if(a(e))return c?c.call(e):"";var r=e+"";return"0"==r&&1/e==-1/0?"-0":r}},379:(t,e,r)=>{var n=r(650),o=r(870),i=r(5),a=n?n.toStringTag:void 0;t.exports=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":a&&a in Object(t)?o(t):i(t)}},403:(t,e,r)=>{var n=r(945),o=/^\s+/;t.exports=function(t){return t?t.slice(0,n(t)+1).replace(o,""):t}},417:t=>{var e=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");t.exports=function(t){return e.test(t)}},426:(t,e,r)=>{var n=r(291),o=r(931),i=r(774),a=r(237),s=r(243),c=r(945);t.exports=function(t,e,r){if((t=s(t))&&(r||void 0===e))return t.slice(0,c(t)+1);if(!t||!(e=n(e)))return t;var u=a(t),h=i(u,a(e))+1;return o(u,0,h).join("")}},454:t=>{t.exports=function(t){return t!=t}},478:(t,e,r)=>{var n=r(250),o=r(454),i=r(706);t.exports=function(t,e,r){return e==e?i(t,e,r):n(t,o,r)}},501:t=>{t.exports=function(t,e,r){var n=-1,o=t.length;e<0&&(e=-e>o?0:o+e),(r=r>o?o:r)<0&&(r+=o),o=e>r?0:r-e>>>0,e>>>=0;for(var i=Array(o);++n<o;)i[n]=t[n+e];return i}},522:e=>{"use strict";e.exports=t},547:t=>{t.exports=function(t){return null!=t&&"object"==typeof t}},650:(t,e,r)=>{var n=r(942).Symbol;t.exports=n},706:t=>{t.exports=function(t,e,r){for(var n=r-1,o=t.length;++n<o;)if(t[n]===e)return n;return-1}},774:(t,e,r)=>{var n=r(478);t.exports=function(t,e){for(var r=t.length;r--&&n(e,t[r],0)>-1;);return r}},837:t=>{t.exports=function(t){return t.split("")}},870:(t,e,r)=>{var n=r(650),o=Object.prototype,i=o.hasOwnProperty,a=o.toString,s=n?n.toStringTag:void 0;t.exports=function(t){var e=i.call(t,s),r=t[s];try{t[s]=void 0;var n=!0}catch(t){}var o=a.call(t);return n&&(e?t[s]=r:delete t[s]),o}},905:(t,e,r)=>{var n=r(478);t.exports=function(t,e){for(var r=-1,o=t.length;++r<o&&n(e,t[r],0)>-1;);return r}},931:(t,e,r)=>{var n=r(501);t.exports=function(t,e,r){var o=t.length;return r=void 0===r?o:r,!e&&r>=o?t:n(t,e,r)}},942:(t,e,r)=>{var n=r(967),o="object"==typeof self&&self&&self.Object===Object&&self,i=n||o||Function("return this")();t.exports=i},945:t=>{var e=/\s/;t.exports=function(t){for(var r=t.length;r--&&e.test(t.charAt(r)););return r}},967:(t,e,r)=>{var n="object"==typeof r.g&&r.g&&r.g.Object===Object&&r.g;t.exports=n}},n={};function o(t){var e=n[t];if(void 0!==e)return e.exports;var i=n[t]={exports:{}};return r[t](i,i.exports,o),i.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},o.d=(t,e)=>{for(var r in e)o.o(e,r)&&!o.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var i={};return(()=>{"use strict";o.d(i,{DecapCmsLibAuth:()=>b});var t=o(107),e=o.n(t),r=o(426),n=o.n(r);class a{constructor(t){this.err=t}toString(){return this.err&&this.err.message}}const s={github:{width:960,height:600},gitlab:{width:960,height:600},bitbucket:{width:960,height:500},email:{width:500,height:400}};var c=o(522),u=o(97);function h(){const t=(0,u.v4)();return window.sessionStorage.setItem("decap-cms-auth",JSON.stringify({nonce:t})),t}function f(t){const e=window.sessionStorage.getItem("decap-cms-auth"),r=e&&JSON.parse(e).nonce;return window.localStorage.removeItem("decap-cms-auth"),t===r}function p(){return"https:"!==document.location.protocol&&"localhost"!==document.location.hostname&&"127.0.0.1"!==document.location.hostname}const l=["access_token"];function d(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function m(t,e,r){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function g(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function w(t,e,r){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}const v="decap-cms-pkce-verifier-code";const b={NetlifyAuthenticator:class{constructor(t={}){this.site_id=t.site_id||null,this.base_url=n()(t.base_url,"/")||"https://api.netlify.com",this.auth_endpoint=e()(t.auth_endpoint,"/")||"auth"}handshakeCallback(t,e){const r=n=>{if(n.data==="authorizing:"+t.provider&&n.origin===this.base_url)return window.removeEventListener("message",r,!1),window.addEventListener("message",this.authorizeCallback(t,e),!1),this.authWindow.postMessage(n.data,n.origin)};return r}authorizeCallback(t,e){const r=n=>{if(n.origin===this.base_url){if(0===n.data.indexOf("authorization:"+t.provider+":success:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+t.provider+":success:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),e(null,o)}if(0===n.data.indexOf("authorization:"+t.provider+":error:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+t.provider+":error:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),e(new a(o))}}};return r}getSiteID(){if(this.site_id)return this.site_id;const t=document.location.host.split(":")[0];return"localhost"===t?"demo.decapcms.org":t}authenticate(t,e){const{provider:r}=t,n=this.getSiteID();if(!r)return e(new a({message:"You must specify a provider when calling netlify.authenticate"}));if(!n)return e(new a({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make authentication work from localhost"}));const o=s[r]||s.github,i=screen.width/2-o.width/2,c=screen.height/2-o.height/2;window.addEventListener("message",this.handshakeCallback(t,e),!1);let u=`${this.base_url}/${this.auth_endpoint}?provider=${t.provider}&site_id=${n}`;t.scope&&(u+="&scope="+t.scope),!0===t.login&&(u+="&login=true"),t.beta_invite&&(u+="&beta_invite="+t.beta_invite),t.invite_code&&(u+="&invite_code="+t.invite_code),this.authWindow=window.open(u,"Netlify Authorization",`width=${o.width}, height=${o.height}, top=${c}, left=${i}`),this.authWindow.focus()}refresh(t,e){const{provider:r,refresh_token:n}=t,o=this.getSiteID(),i=e||Promise.reject.bind(Promise);if(!r||!n)return i(new a({message:"You must specify a provider and refresh token when calling netlify.refresh"}));if(!o)return i(new a({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make token refresh work from localhost"}));const s=`${this.base_url}/${this.auth_endpoint}/refresh?provider=${r}&site_id=${o}&refresh_token=${n}`,c=fetch(s,{method:"POST",body:""}).then(t=>t.json());if(!e)return c;c.then(t=>e(null,t)).catch(e)}},ImplicitAuthenticator:class{constructor(t={}){const r=n()(t.base_url,"/"),o=e()(t.auth_endpoint,"/");this.auth_url=`${r}/${o}`,this.appID=t.app_id,this.clearHash=t.clearHash}authenticate(t,e){if(p())return e(new Error("Cannot authenticate over insecure protocol!"));const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","token"),r.searchParams.set("scope",t.scope),null!=t.prompt&&null!=t.prompt&&r.searchParams.set("prompt",t.prompt),null!=t.resource&&null!=t.resource&&r.searchParams.set("resource",t.resource);const n=JSON.stringify({auth_type:"implicit",nonce:h()});r.searchParams.set("state",n),document.location.assign(r.href)}completeAuth(t){const e=new URLSearchParams(document.location.hash.replace(/^#?\/?/,""));if(!e.has("access_token")&&!e.has("error"))return;this.clearHash();const r=(0,c.Map)(e.entries()),{nonce:n}=JSON.parse(r.get("state"));if(!f(n))return t(new Error("Invalid nonce"));if(r.has("error"))return t(new Error(`${r.get("error")}: ${r.get("error_description")}`));if(r.has("access_token")){const e=r.toJS(),{access_token:n}=e;t(null,function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?d(Object(r),!0).forEach(function(e){m(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({token:n},function(t,e){if(null==t)return{};var r,n,o=function(t,e){if(null==t)return{};var r={};for(var n in t)if({}.hasOwnProperty.call(t,n)){if(-1!==e.indexOf(n))continue;r[n]=t[n]}return r}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],-1===e.indexOf(r)&&{}.propertyIsEnumerable.call(t,r)&&(o[r]=t[r])}return o}(e,l)))}}},PkceAuthenticator:class{constructor(t={}){const r=t.use_oidc,o=n()(t.base_url,"/"),i=e()(t.auth_endpoint,"/"),a=e()(t.auth_token_endpoint,"/");r?this.oidc_url=o:(this.auth_url=`${o}/${i}`,this.auth_token_url=`${o}/${a}`),this.auth_token_endpoint_content_type=t.auth_token_endpoint_content_type,this.appID=t.app_id}async _loadOidcConfig(){if(this.auth_url&&this.auth_token_url)return;if(!this.oidc_url)throw new Error("Missing auth URLs");const t=await fetch(`${this.oidc_url}/.well-known/openid-configuration`).catch(()=>{throw new Error("Failed to load OIDC configuration")});if(!t.ok)throw new Error("Bad response while getting OIDC configuration");const e=await t.json().catch(()=>{throw new Error("Failed to parse OIDC configuration JSON")});if(!e.authorization_endpoint||!e.token_endpoint)throw new Error("OIDC configuration missing endpoint fields");this.auth_url=e.authorization_endpoint,this.auth_token_url=e.token_endpoint}async authenticate(t,e){if(p())return e(new Error("Cannot authenticate over insecure protocol!"));try{await this._loadOidcConfig()}catch(t){return e(t)}const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","code"),r.searchParams.set("scope",t.scope);const n=JSON.stringify({auth_type:"pkce",nonce:h()});r.searchParams.set("state",n),r.searchParams.set("code_challenge_method","S256");const o=function(){const t=Array.from(window.crypto.getRandomValues(new Uint8Array(128))).map(t=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-."[t%64]).join("");return window.sessionStorage.setItem(v,t),t}(),i=await async function(t){const e=await async function(t){const e=(new TextEncoder).encode(t),r=await window.crypto.subtle.digest("SHA-256",e);return String.fromCharCode(...new Uint8Array(r))}(t);return btoa(e).split("=")[0].replace(/\+/g,"-").replace(/\//g,"_")}(o);r.searchParams.set("code_challenge",i),document.location.assign(r.href)}async completeAuth(t){const e=new URLSearchParams(document.location.search);if(window.history.replaceState(null,"",document.location.pathname),!e.has("code")&&!e.has("error"))return;let r;try{r=JSON.parse(e.get("state")).nonce}catch(t){r=JSON.parse(e.get("state").replace(/\\"/g,'"')).nonce}if(!f(r))return t(new Error("Invalid nonce"));if(e.has("error"))return t(new Error(`${e.get("error")}: ${e.get("error_description")}`));if(e.has("code")){try{await this._loadOidcConfig()}catch(e){return t(e)}const r=e.get("code"),n=new URL(this.auth_token_url),o={client_id:this.appID,code:r,grant_type:"authorization_code",redirect_uri:document.location.origin+document.location.pathname,code_verifier:window.sessionStorage.getItem(v)},i=await fetch(n.href,{method:"POST",body:this.auth_token_endpoint_content_type.startsWith("application/x-www-form-urlencoded")?new URLSearchParams(Object.entries(o)).toString():JSON.stringify(o),headers:{"Content-Type":this.auth_token_endpoint_content_type}}),a=await i.json();window.sessionStorage.removeItem(v),t(null,function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?g(Object(r),!0).forEach(function(e){w(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({token:a.access_token},a))}}}}})(),i.DecapCmsLibAuth})());
//# sourceMappingURL=decap-cms-lib-auth.js.map