{{ define "main" }}

{{ $pub_type_csl := "" }}
{{ $pub_type_display := "" }}
{{ if .Params.publication_types }}
  {{ if reflect.IsSlice .Params.publication_types }}
    {{ $pub_type_csl = index .Params.publication_types 0 }}
    {{ $pub_type_display = i18n (printf "pub_%s" (strings.Replace $pub_type_csl "-" "_")) | default (strings.Title $pub_type_csl) }}
  {{ end }}
{{ end }}

<div class="mx-auto flex max-w-screen-xl">
  {{ partial "components/sidebar.html" (dict "context" . "no_sidebar" true) }}
  {{ partial "components/toc.html" . }}
  <article class="w-full break-words flex min-h-[calc(100vh-var(--navbar-height))] min-w-0 justify-center pb-8 pr-[calc(env(safe-area-inset-right)-1.5rem)]">
    <main class="w-full min-w-0 max-w-6xl px-6 pt-4 md:px-12">
      <p class="mt-0 text-2xl font-bold italic mb-6">
        {{ .Description | emojify }}
      </p>

      {{ if .Params.show_breadcrumb }}
      <div class="mb-4">
        {{ partial "components/breadcrumb.html" . }}
      </div>
      {{ end }}

      <h1 class="mt-2 text-4xl font-bold tracking-tight text-slate-900 dark:text-slate-100">
        {{- .Title -}}
      </h1>

      <div class="mt-4 mb-16">
      <div class="text-gray-500 dark:text-gray-300 text-sm flex items-center flex-wrap gap-y-2">
        {{- if .Date | and (not .Params.hide_date) -}}
        <span class="mr-1">{{- .Date | time.Format (site.Params.locale.date_format | default ":date_long") -}}</span>
        {{- if .Params.authors }}<span class="mx-1">¬∑</span>{{ end -}}
        {{- end -}}

        {{/* Set Alpine.js flag if author notes exist */}}
        {{ if isset .Params "author_notes" }}
          {{ .Store.Set "has_alpine" true }}
          <script>console.log('Author notes detected in single.html, Alpine.js should load');</script>
        {{ end }}

        {{ $taxonomy := "authors" }}
        {{ range $i, $author_obj := (.GetTerms $taxonomy) }}
          {{ $author_page := $author_obj.Page }}
          {{ $avatar := ($author_page.Resources.ByType "image").GetMatch "*avatar*" }}
          {{- if and $i (not $avatar) }}<span class="mr-1">,</span>{{ end -}}
          {{ with $author_page.Params.website }}
          <a href="{{.}}" target="_blank" rel="noreferrer">
          {{ end }}
          <div class="group inline-flex items-center text-current gap-x-1.5 mx-1">
            {{ with $avatar }}
              {{/* Simple 2x retina image for small avatar */}}
              {{ $avatar_32 := $avatar.Process "Fill 32x32 Center webp" }}
              <img src="{{ $avatar_32.RelPermalink }}" 
                   width="16"
                   height="16"
                   alt="{{ $author_page.Title }}" 
                   class="inline-block h-4 w-4 rounded-full border border-current" 
                   loading="lazy" />
            {{ end }}
            <div {{if $author_page.Params.website}}class="group-hover:underline"{{end}}>{{ $author_page.Title }}</div>
          </div>
          {{ with $author_page.Params.website }}
          </a>
          {{ end }}
          {{/* Add author note tooltip if available */}}
          {{- if isset $.Params "author_notes" -}}
            {{- with (index $.Params.author_notes $i) -}}
              <span class="relative inline-block ml-1" x-data="{ tooltip: false }">
                <button
                  @mouseenter="tooltip = true"
                  @mouseleave="tooltip = false"
                  @click="tooltip = !tooltip"
                  class="author-notes text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 transition-colors cursor-help"
                  data-tooltip="{{.}}"
                  aria-label="{{.}}"
                  type="button"
                >
                  <svg class="inline-block w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                </button>
                <div
                  x-show="tooltip"
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 transform scale-95"
                  x-transition:enter-end="opacity-100 transform scale-100"
                  x-transition:leave="transition ease-in duration-150"
                  x-transition:leave-start="opacity-100 transform scale-100"
                  x-transition:leave-end="opacity-0 transform scale-95"
                  @click.away="tooltip = false"
                  class="absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-sm text-white bg-gray-900 dark:bg-gray-700 rounded-lg shadow-lg whitespace-nowrap"
                  x-cloak
                >
                  {{.}}
                  <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
                </div>
              </span>
            {{- end -}}
          {{- end -}}
        {{ end }}

        {{ if ne .Params.reading_time false }}
        <span class="mx-1">¬∑</span>
        <span class="mx-1">
              {{ .ReadingTime }} {{ i18n "minute_read" }}
        </span>
        {{ end }}
        <span class="mx-1">¬∑</span>
            üóÅ &nbsp; {{ range (.GetTerms "categories") }}
          <span class="inline-block px-1">
          <a href="{{ .RelPermalink }}" class="text-sm no-underline">
                  {{ .LinkTitle }}</a>
          </span>
          {{ end }}
        </span>
        </div>
  
      <div class="container mx-auto prose prose-slate lg:prose-xl dark:prose-invert">
        {{- if .Params.series -}}
   <details class="mt-3 overflow-hidden rounded text-base">
    <summary
          class="py-1 cursor-pointer bg-primary text-lg font-semibold">
          {{ index .Params.series -0 }} - {{ i18n "is_part_of_series" }}
      </summary>
       <div class="post-series">
         {{- $series := where .Site.RegularPages.ByDate ".Params.series" "intersect" .Params.series -}}
         {{- with $series -}}
           <ol class="mt-3 text-base">
             {{- range . -}}
               <li>
                 {{- if eq .File.UniqueID $.File.UniqueID -}}
                   <b>{{ .Title }}</b>
                 {{- else -}}
                   <a href="{{ .Permalink }}">{{ .Title }}</a>
                 {{- end -}}
               </li>
             {{- end -}}
           </ol>
         {{- end -}}
       </div>
      </details>
     {{- end -}}
     <!-- start icon links -->
        {{/* Strong Primary Color Links */}}
{{ if .Params.links }}
<div class="icon-links mb-6">
  <div class="flex flex-wrap items-center gap-2 text-sm">
    {{ range .Params.links }}
      <a href="{{ .url }}" 
         target="{{ if or (hasPrefix .url "http") (hasPrefix .url "//") }}_blank{{ end }}"
         rel="{{ if or (hasPrefix .url "http") (hasPrefix .url "//") }}noopener noreferrer{{ end }}"
         class="inline-flex items-center text-gray-500 dark:text-gray-300 hover:text-primary-800 dark:hover:text-primary-200 transition-colors duration-200 font-medium"
         title="{{ .name }}"
         aria-label="{{ .name }}">
        
        {{ with .icon }}
          <span class="inline-block mr-2" style="width: 1em; height: 1em; font-size: 1em;">
            {{ partial "functions/get_icon" (dict "name" .) }}
          </span>
        {{ end }}
        
        <span>{{ .name }}</span>
      </a>
    {{ end }}
  </div>
</div>
{{ end }}
<!-- end icons links -->
      </div>

      {{ $featured := partial "functions/get_featured_image.html" . }}
      {{/* Featured image layout */}}
      {{ if and $featured (not .Params.image.preview_only) }}
      {{/* Fit image within max size. */}}
      {{ $image := $featured }}

      {{/* Determine image placement. */}}
      {{ $placement := .Params.image.placement | default 1 }}{{/* Default to full column width. */}}
      {{/* Configure responsive processing based on placement */}}
      {{ $image_container := "" }}
      {{ $responsive_sizes := slice }}
      {{ $sizes_attr := "" }}
      {{ if eq $placement 2}}
        {{ $image_container = "container" }}
        {{ $responsive_sizes = slice 480 768 1024 1200 1600 }}
        {{ $sizes_attr = "(max-width: 480px) 100vw, (max-width: 768px) 90vw, (max-width: 1200px) 80vw, 1200px" }}
      {{else if eq $placement 3}}
        {{ $image_container = "container-fluid" }}
        {{ $responsive_sizes = slice 768 1024 1366 1920 2560 }}
        {{ $sizes_attr = "(max-width: 768px) 100vw, (max-width: 1366px) 90vw, (max-width: 1920px) 80vw, 2560px" }}
      {{else}}
        {{ $image_container = "article-container" }}
        {{ $responsive_sizes = slice 320 480 640 720 960 }}
        {{ $sizes_attr = "(max-width: 480px) 100vw, (max-width: 640px) 90vw, (max-width: 720px) 80vw, 720px" }}
      {{end}}
      
      {{/* Process featured image using utility with placement-specific constraints */}}
      {{ if ne $featured.MediaType.SubType "gif" }}
        {{/* Pre-fit image to placement constraints, then apply responsive processing */}}
        {{ $fitted_image := $featured }}
        {{ if eq $placement 2}}
          {{ $fitted_image = $featured.Fit "1200x2500" }}
        {{else if eq $placement 3}}
          {{ $fitted_image = $featured.Fit "2560x2560" }}
        {{else}}
          {{ $fitted_image = $featured.Fit "720x2500" }}
        {{end}}
        
        {{ $responsive := partial "functions/process_responsive_image.html" (dict 
            "image" $fitted_image 
            "mode" "responsive"
            "sizes" $responsive_sizes
        ) }}
        
        {{/* Featured image - use fitted image dimensions for container, responsive for srcset */}}
        <div class="article-header {{$image_container}} featured-image-wrapper mt-4 mb-16" style="max-width: {{$fitted_image.Width}}px; max-height: {{$fitted_image.Height}}px;">
          <div style="position: relative">
            <img srcset="{{ $responsive.srcset }}"
                 sizes="{{ $sizes_attr }}"
                 src="{{ $responsive.fallback.RelPermalink }}" 
                 width="{{ $fitted_image.Width }}" 
                 height="{{ $fitted_image.Height }}" 
                 alt="{{ with $.Params.image.alt_text }}{{.}}{{ end }}" 
                 class="featured-image"
                 fetchpriority="high">
            {{ with $.Params.image.caption }}<span class="article-header-caption">{{ . | markdownify | emojify }}</span>{{ end }}
          </div>
        </div>
      {{ else }}
        {{/* Handle GIF - apply same placement constraints without responsive processing */}}
        {{ $image := $featured }}
        {{ if eq $placement 2}}
          {{ $image = $featured.Fit "1200x2500" }}
        {{else if eq $placement 3}}
          {{ $image = $featured.Fit "2560x2560" }}
        {{else}}
          {{ $image = $featured.Fit "720x2500" }}
        {{end}}
        <div class="article-header {{$image_container}} featured-image-wrapper mt-4 mb-16" style="max-width: {{$image.Width}}px; max-height: {{$image.Height}}px;">
          <div style="position: relative">
            <img src="{{ $image.RelPermalink }}" 
                 width="{{ $image.Width }}" 
                 height="{{ $image.Height }}" 
                 alt="{{ with $.Params.image.alt_text }}{{.}}{{ end }}" 
                 class="featured-image"
                 fetchpriority="high">
            {{ with $.Params.image.caption }}<span class="article-header-caption">{{ . | markdownify | emojify }}</span>{{ end }}
          </div>
        </div>
      {{ end }}
      {{end}}

            <!-- Mobile TOC -->
      <details class="lg:hidden mb-3 overflow-hidden rounded">
    <summary class="docs-toc-title bg-primary text-lg font-semibold">
      {{ i18n "on_this_page" }}
    </summary>
    <div class="">
      {{ .TableOfContents | emojify }}
    </div>
  </details>
        <!-- End Mobile TOC -->

      {{/* EVENT / PUBLICATION METADATA */}}
      {{ if .Params.abstract | or (eq .Type "publication") | or (eq .Type "event") }}
        <div class="max-w-prose grid grid-cols-1 md:grid-cols-[200px_auto] gap-4 my-6">

        {{ if .Params.abstract }}
          <div class="font-bold text-2xl">{{ i18n "abstract" }}</div>
          <div>{{ .Params.abstract | markdownify }}</div>
        {{ end }}

        {{/* If the type is Uncategorized, hide the type. */}}
        {{ if $pub_type_display }}
          <div class="font-bold text-2xl">{{ i18n "publication_type" }}</div>
          <div>
            {{ if and .Params.publication_types (gt (len .Params.publication_types) 0) }}
            <a href="{{ range first 1 (.GetTerms "publication_types") }}{{.RelPermalink}}{{end}}">
            {{ $pub_type_display }}
            </a>
            {{ end }}
          </div>
        {{ end }}

        {{ if .Params.publication }}
          <div class="font-bold text-2xl">{{ i18n "publication" }}</div>
          <div>{{ .Params.publication | markdownify }}</div>
        {{ end }}

        {{ if eq .Type "event" }}
          <div class="font-bold text-2xl">{{ i18n "date" }}</div>
          <div>
            {{ partial "functions/get_event_dates" . }}
          </div>
        {{ end }}

        {{ if .Params.event }}
          <div class="font-bold text-2xl">{{ i18n "event" }}</div>
          <div>
            {{ with .Params.event_url }}<a href="{{ . }}" target="_blank" rel="noopener">{{ end }}
            {{ .Params.event | markdownify }}
            {{ if .Params.event_url }}</a>{{ end }}
          </div>
        {{ end }}

        {{ if .Params.location }}
          <div class="font-bold text-2xl">{{ i18n "location" }}</div>
          <div>
            <p>{{ .Params.location | markdownify }}</p>
            {{ if .Params.address }}
              <p>{{partial "functions/get_address" (dict "root" . "address" .Params.address) }}</p>
            {{end}}
          </div>
        {{ end }}

      </div>
      {{ end }}
      <div class="prose prose-slate lg:prose-xl dark:prose-invert">
        {{ .Content }}
      </div>
      <!-- CONTACT LINK SECTION - HugoBlox Standard with Rounded Full -->
<div class="text-center pt-6 pb-4 border-t border-gray-200 dark:border-gray-700 mt-8">
  <div class="max-w-2xl mx-auto">
  <p class="text-lg text-gray-500 dark:text-gray-400 mb-4">
    Ready to make a difference? Let's start the conversation.
  </p>
  <a href="/about/contact" 
     class="inline-flex items-center justify-center px-6 py-3 text-sm font-medium text-gray-900 dark:text-white bg-gray-300 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700"
     aria-label="Contact us to learn how you can get involved">
    <!-- Chat icon: Changed from w-4 h-4 to w-6 h-6 -->
    <svg class="w-6 h-6 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    Discover What Happens When You Reach Out
    <!-- Arrow icon: Changed from w-3.5 h-3.5 to w-5 h-5 -->
    <svg class="w-5 h-5 ms-2 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 14 10" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
    </svg>
  </a>
</div>

</div>

      <style>
@keyframes pulse-heart {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.15);
    opacity: 0.7;
  }
}
.animate-pulse-heart {
  animation: pulse-heart 1.5s ease-in-out infinite;
  transform-origin: center;
}
</style>

<div class="text-left pt-8 pb-4">
  <a href="/donate" class="inline-block"><button class="flex justify-center items-center cursor-pointer rounded-full bg-primary-600 dark:bg-primary-900 px-6 py-3 sm:px-8 sm:py-4 text-base sm:text-lg font-semibold sm:font-bold text-white shadow-sm hover:bg-primary-500 transition-colors duration-300" type="button" aria-label="Donate Now"><svg class="w-6 h-6 mr-3 text-red-500 animate-pulse-heart" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      Donate Now</button></a>
</div>
      <!-- {{ partial "components/last-edited.html" . }} -->
      <div class="container mx-auto prose prose-slate lg:prose-xl dark:prose-invert mt-5">
        <!-- https://discourse.gohugo.io/t/cite-the-blog-post/19190/14 -->
      
  {{ $names := slice }}
  {{ range .GetTerms "authors" }}
  {{ $names = $names | append .Page.Title }}    
  {{ end }}
  {{ $authors := delimit $names "; " }}           
  {{ $date_format := "2006" }}
  {{ $publish_date := .Page.PublishDate.Format $date_format }}
  {{ $lastmod := .Lastmod.Format "2006" }}
  {{ $title := .Page.Title }}
  {{ $permalink := .Page.Permalink }}
  <p class="text-sm">
    <span class="font-bold">Copyright:</span> <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" title="creative common copyright" target="_blank">¬© CC BY-SA 4.0</a><br>
    <span id="bib-btn" class="font-bold">Download: <a href id="bib-btn" class="font-bold">BibTeX</a></span><br>
    <span class="font-bold">Citation</span>&nbsp; For attribution, please cite this work as:<br>
  {{ printf "%s, (%s) %s. %s" $authors $publish_date $title $permalink }}
  </p>

  <!-- Build BibTeX entry -->
      {{/* build author list for BibTeX field */}}
      {{ $names := slice }}
      {{ range .GetTerms "authors" }}
        {{ $names = $names | append .Page.Title }}
      {{ end }}
      {{ $authorList := delimit $names " and " }}
      
      {{/* pick the FIRST author only */}}
      {{ $firstAuthor := index $names 0 }}
      
      {{/* optional: keep only last name */}}
      {{ $lastName := index (last 1 (split $firstAuthor " ")) 0 }}
      
      {{/* anchorize the single last name + year */}}
      {{ $year := .Date.Format "2006" }}
      {{ $entryKey := printf "%s%s" $lastName $year | anchorize }}
      
      <textarea id="bib-src" class="hidden">{{ printf `@article{%s,
        author = {%s},
        title  = {%s},
        year   = {%s},
        url    = {%s}
      }` $entryKey $authorList .Title $year .Permalink }}</textarea>
      
      <script>
      document.getElementById('bib-btn').addEventListener('click', () => {
        const data = document.getElementById('bib-src').value.trim();
        const blob = new Blob([data], {type:'application/x-bibtex'});
        const a    = Object.assign(document.createElement('a'), {
                    href: URL.createObjectURL(blob),
                    download: '{{ $entryKey }}.bib'});
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });
      </script>
      
      {{ partial "blox/ai-chat.html" . }}
          <!-- {{/* Generate BibTeX citation */}}
          {{ $year := dateFormat "2006" .Date }}
          {{ $names := slice }}
          {{ range .GetTerms "authors" }}
          {{ $names = $names | append .Page.Title }}    
          {{ end }}
          {{ $authors := delimit $names "; " }}  
          <span class="font-bold">Bibtex</span>
          <pre class="bibtex">
          @article{
            {{ $authors }}{{ $year }},
            author = { {{ $authors }} },
            year = { {{ $year }} },
            title = { {{ .Title }} },
            url = { {{ .Permalink }} }
        }
        </pre> -->
        
        {{ .Scratch.Set "invert_pager" true }}
        {{ partial "page_footer" . }}
      </div>
    </main>
  </article>
</div>
{{ end }}
