{{- $page := .Page -}}
{{- $title := $page.Title -}}

{{/* Content extraction (same robust logic) */}}
{{- $content := "" -}}
{{- $raw := $page.RawContent | default "" -}}
{{- if gt (len $raw) 50 -}}
  {{- $cleaned := $raw | replaceRE `\{\{<[^}]*>\}\}` "" | replaceRE `\s+` " " | trim " " -}}
  {{- if gt (len $cleaned) 20 -}}
    {{- $content = $cleaned -}}
  {{- else -}}
    {{- $content = $raw | truncate 2000 -}}
  {{- end -}}
{{- else -}}
  {{- $content = printf "Article: %s - Analysis of charitable giving and community support themes." $title -}}
{{- end -}}

{{- $contentJson := $content | jsonify -}}
{{- $ordinal := .Ordinal -}}

<!-- AI Chat Perplexity - Exact Series Design Match -->
<div class="container mx-auto prose prose-slate lg:prose-xl dark:prose-invert">
  <details class="mt-3 overflow-hidden rounded text-base">
    <summary class="py-1 cursor-pointer bg-primary text-lg font-semibold text-white px-3">
      AI Chat Perplexity
    </summary>
    <div class="post-series">
      <ol class="mt-3 text-base">
        <li>
          <a href="#" onclick="launchSeriesAnalysis('comprehensive', {{ $contentJson }}, {{ $ordinal }}); return false;" 
             class="text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300">
            üìä Comprehensive Analysis
          </a>
          <span class="text-sm text-gray-600 dark:text-gray-400 ml-2">- Complete breakdown and detailed insights</span>
        </li>
        
        <li>
          <a href="#" onclick="launchSeriesAnalysis('charity', {{ $contentJson }}, {{ $ordinal }}); return false;" 
             class="text-green-600 hover:text-green-800 hover:underline dark:text-green-400 dark:hover:text-green-300">
            üíù Charity & Impact Analysis
          </a>
          <span class="text-sm text-gray-600 dark:text-gray-400 ml-2">- Focus on charitable themes and community impact</span>
        </li>
        
        <li>
          <a href="#" onclick="launchSeriesAnalysis('practical', {{ $contentJson }}, {{ $ordinal }}); return false;" 
             class="text-purple-600 hover:text-purple-800 hover:underline dark:text-purple-400 dark:hover:text-purple-300">
            ‚ö° Practical Applications
          </a>
          <span class="text-sm text-gray-600 dark:text-gray-400 ml-2">- How to help and contribute effectively</span>
        </li>
        
        <li>
          <a href="#" onclick="launchSeriesAnalysis('questions', {{ $contentJson }}, {{ $ordinal }}); return false;" 
             class="text-orange-600 hover:text-orange-800 hover:underline dark:text-orange-400 dark:hover:text-orange-300">
            ‚ùì Discussion Questions
          </a>
          <span class="text-sm text-gray-600 dark:text-gray-400 ml-2">- Topics to explore and discuss further</span>
        </li>
      </ol>
      
      <!-- Custom Question Section -->
      <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">üí¨ Ask Your Own Question:</p>
        <div class="flex gap-2 mb-3">
          <input type="text" 
                 id="series-custom-input-{{ $ordinal }}" 
                 placeholder="What would you like to explore about this content?"
                 class="flex-1 rounded-lg border border-gray-300 px-3 py-1 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
          <button onclick="launchSeriesAnalysis('custom', {{ $contentJson }}, {{ $ordinal }})" 
                  class="rounded-lg bg-primary-700 px-3 py-1 text-sm font-medium text-white transition-colors hover:bg-primary-900" style="cursor: pointer;">
            Ask AI
          </button>
        </div>
        
        <!-- Status Info -->
        <div class="text-xs text-gray-500 dark:text-gray-400">
          ‚úÖ Content ready: {{ len $content }} characters ‚Ä¢ Analysis powered by Perplexity AI
        </div>
      </div>
    </div>
  </details>
</div>

<script>
(function() {
  window.launchSeriesAnalysis = function(type, content, ordinal) {
    let prompt = '';
    
    switch(type) {
      case 'comprehensive':
        prompt = `Please provide a comprehensive analysis of the following content about charitable giving and community support. Include key themes, main ideas, and detailed insights:

Content to analyze:
${content}`;
        break;
        
      case 'charity':
        prompt = `Analyze this content focusing specifically on charitable themes, community impact, and giving. What are the key messages about helping others and making a difference?

Content about charity and giving:
${content}`;
        break;
        
      case 'practical':
        prompt = `Based on this content about charitable giving and community support, what are the practical ways people can help and contribute? Provide actionable insights and specific steps:

Content for practical analysis:
${content}`;
        break;
        
      case 'questions':
        prompt = `Generate thoughtful discussion questions based on this content about charity, giving, and community support. What topics deserve further exploration?

Content for question generation:
${content}`;
        break;
        
      case 'custom':
        const input = document.getElementById(`series-custom-input-${ordinal}`);
        if (!input || !input.value.trim()) {
          alert('Please enter your question first!');
          if (input) input.focus();
          return;
        }
        prompt = `Question: ${input.value.trim()}

Please answer based on this content about charitable giving and community support:
${content}`;
        input.value = '';
        break;
    }
    
    // Open Perplexity with the prompt
    const perplexityUrl = `https://www.perplexity.ai/?q=${encodeURIComponent(prompt)}`;
    window.open(perplexityUrl, '_blank');
  };

  // Enter key support for custom input
  const input = document.getElementById(`series-custom-input-{{ $ordinal }}`);
  if (input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        launchSeriesAnalysis('custom', {{ $contentJson }}, {{ $ordinal }});
      }
    });
  }
})();
</script>
